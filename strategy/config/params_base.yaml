# strategy/config/params_base.yaml
# version: "3.0"
# strategy_name: "solana-copy-scalp"
#
# This is runtime configuration (read by code). Docs live in strategy/docs/**.
version: "3.0"
strategy_name: "solana-copy-scalp"

run:
  timezone: "Europe/Riga"
  mode: "paper"  # paper | sim | live

  # PR-G.3: Safety gate for live trading
  safety:
    live_trading_enabled: false

  live_safety:
    require_honeypot_pass: true
    require_min_liquidity_pass: true
    require_risk_limits_pass: true
    require_rpc_health: true

wallet_profile:
  universe:
    max_wallets_total: 1500
    live_track_wallets: 300
    refresh_daily: true

  filters:
    lookback_days: 30
    min_trades_30d: 50
    min_roi_30d_pct: 20.0
    min_winrate_30d: 0.60
    min_avg_trade_size_sol: 0.20
    min_wallet_age_days: 7

  tiering:
    tier0:
      max_wallets: 50
      min_roi_30d_pct: 40.0
      min_winrate_30d: 0.65
      min_trades_30d: 80
    tier1:
      max_wallets: 250
      min_roi_30d_pct: 25.0
      min_winrate_30d: 0.60
      min_trades_30d: 50
    tier2:
      max_wallets: 1200
      min_roi_30d_pct: 10.0
      min_winrate_30d: 0.55
      min_trades_30d: 30

  clustering:
    enabled: true
    graph:
      build_graph: true
      lookback_days: 14
      leader_min_indegree: 3
      edge_rule: "co_trade_same_token_within_seconds"
      co_trade_window_sec: 45
    roles:
      enable_role_labels: true
      deployer_heuristics: true
      sniper_heuristics: true
      follower_heuristics: true

token_profile:
  gates:
    min_liquidity_usd: 15000
    min_volume_24h_usd: 50000
    max_spread_bps: 200
    max_top10_holders_pct: 85
    max_single_holder_pct: 35

  honeypot:
    enabled: true
    reject_if_freeze_authority_present: true
    reject_if_mint_authority_present: false
    reject_if_blacklist_features_detected: true
    reject_if_sell_tax_pct_ge: 50
    reject_if_transfer_tax_pct_ge: 50
    probe_trade:
      enabled: false
      max_probe_cost_usd: 3
      probe_slippage_bps: 300
      reject_if_sell_fails: true
      reject_if_effective_tax_pct_ge: 35

  dex_distribution_hint:
    raydium_pct: 40
    jupiter_pct: 30
    pumpfun_pct: 20
    meteora_pct: 10

features:
  windows_sec:
    vol_30s: 30
    vol_5m: 300
    ret_30s: 30
    ret_1m: 60
    ret_5m: 300

  include:
    token_microstructure: true
    wallet_stats: true
    smart_money_counts: true
    polymarket_overlay: false
    survival_exit_hazard: true

  smart_money:
    co_entry_window_sec: 30
    min_co_entries_for_boost: 2

model:
  type: "xgboost"  # logistic | xgboost | lightgbm
  target:
    horizon_sec: 300
    label_threshold_roi_pct: 0.0

  training:
    lookback_days: 90
    timeseries_splits: 5
    min_samples: 5000
    retrain:
      enabled: true
      cadence: "weekly"  # daily | weekly | manual

  calibration:
    method: "platt"  # platt | isotonic | none

  thresholds:
    p_model_min: 0.58
    p_model_min_risk_off: 0.62
    p_model_min_risk_on: 0.56

signals:
  ev:
    enabled: true
    edge_threshold_pct: 5.0
    use_edge: false
    assumed_costs:
      slippage_bps: 80
      fees_bps: 30
      latency_bps: 60

  hard_filters:
    require_wallet_tier: ["tier0", "tier1", "tier2"]
    min_wallet_winrate_30d: 0.55
    min_wallet_roi_30d_pct: 10.0
    require_token_gates_pass: true
    require_honeypot_pass: true

  modes:
    # You may split modes into a separate file later (strategy/config/modes.yaml),
    # but params_base.yaml is the single source of truth for the runner.
    base_profiles:
      U: {hold_sec_min: 15, hold_sec_max: 30, tp_pct: 3.0, sl_pct: -2.5, ttl_sec: 30}
      S: {hold_sec_min: 60, hold_sec_max: 90, tp_pct: 5.0, sl_pct: -4.5, ttl_sec: 90}
      M: {hold_sec_min: 120, hold_sec_max: 180, tp_pct: 9.0, sl_pct: -7.0, ttl_sec: 180}
      L: {hold_sec_min: 240, hold_sec_max: 300, tp_pct: 14.0, sl_pct: -10.0, ttl_sec: 300}

    choose_mode:
      U_if_median_hold_sec_lt: 40
      S_if_median_hold_sec_lt: 100
      M_if_median_hold_sec_lt: 220
      else_mode: "L"
      high_vol_30s_threshold: 0.08
      if_high_vol_shift_towards: "U"
      low_vol_30s_threshold: 0.02
      if_low_vol_shift_towards: "M"

    aggressive:
      enabled: true
      # Aggressive mode triggers: switch from base mode when conditions met
      triggers:
        U_aggr: {base: "U", dt_max: 15, min_chg: 0.03, partial: 0.4, trail: 0.12}
        S_aggr: {base: "S", dt_max: 30, min_chg: 0.06, partial: 0.5, trail: 0.12}
        M_aggr: {base: "M", dt_max: 60, min_chg: 0.10, partial: 0.4, trail: 0.15}
        L_aggr: {base: "L", dt_max: 90, min_chg: 0.15, partial: 0.35, trail: 0.20}

      # Default aggressive profile settings
      defaults:
        partial_take_profit_pct_of_pos: 40
        runner_tp_pct: 25.0
        runner_sl_pct: -7.0

      safety_filters:
        # PR-E.2.1: Aggressive mode safety gates
        # Hierarchy: Global Risk State > Token Safety > Wallet Quality
        wallet:
          min_winrate_30d: 0.60
          min_roi_30d_pct: 25.0
        token:
          min_liquidity_usd: 20000
          max_top10_holders_pct: 0.85
        risk_state:
          disable_if_daily_loss_ge: 0.05  # Block aggr if daily loss >= 5%
        limits:
          max_aggr_trades_per_day: 10
          max_aggr_open_positions: 3
        # Existing filters
        min_wallet_tier: "tier1"
        min_wallet_winrate_30d: 0.60
        min_wallet_roi_30d_pct: 20.0
        min_liquidity_usd: 20000
        max_spread_bps: 180
        require_honeypot_pass: true
        require_risk_regime_not_risk_off: true
        require_not_in_cooldown: true

      limits:
        max_aggr_trades_per_day: 10
        max_aggr_exposure_pct_of_bankroll: 8.0
        disable_aggr_if_aggr_drawdown_pct_ge: 12.0
        disable_aggr_if_aggr_winrate_lt: 0.45

      chain_reaction:
        enabled: true
        leader_min_indegree: 3
        exit_hazard_threshold: 0.70
        reaction_window_sec: 30
        action: "tighten_sl_or_exit"  # tighten_sl_or_exit | immediate_exit | ignore

polymarket:
  enabled: false
  refresh_sec: 60
  regime:
    risk_on_threshold: 0.25
    risk_off_threshold: -0.25
  adjustments:
    size_multiplier_risk_on: 1.25
    size_multiplier_risk_off: 0.60
    max_open_positions_multiplier_risk_on: 1.20
    max_open_positions_multiplier_risk_off: 0.70

risk:
  sizing:
    method: "fractional_kelly"  # fixed_pct | fractional_kelly
    fixed_pct_of_bankroll: 1.0
    kelly_fraction: 0.25
    min_pos_pct: 0.5
    max_pos_pct: 2.0

  proxy_edge:
    enabled: true
    p_model_baseline: 0.55
    edge_per_0_01_p: 1.5

  limits:
    max_open_positions: 20
    max_open_positions_per_dex: 8
    max_exposure_per_token_pct: 10.0
    max_exposure_per_wallet_source_pct: 12.0
    max_daily_loss_pct: 7.0
    max_drawdown_total_pct: 25.0

    kill_switch_on_drawdown: true
    cooldown:
      enabled: true
      trigger_after_consecutive_losses: 3
      cooldown_minutes: 45
      during_cooldown:
        force_base_only: true
        raise_p_model_min_by: 0.03

execution:
  venue:
    use_jupiter_routing: true
    allowed_dex: ["raydium", "jupiter", "pumpfun", "meteora"]

  orders:
    default_order_type: "limit"  # limit | market
    limit_price_buffer_bps: 50
    max_slippage_bps: 200
    allow_partial_fills: true

  ttl:
    default_ttl_sec: 120
    per_mode_override: true

  fees:
    swap_fee_bps: 30
    priority_fee_lamports: 0
    mev_tip_sol: 0.0

  mev:
    jito_bundles:
      enabled: false
    max_tip_sol: 0.01
    fallback_to_normal_tx: true

  latency:
    enabled: true
    observe_delay_ms:
      dist: "lognormal"
      mean: 250
      sigma: 0.40
      clamp_min: 80
      clamp_max: 900
    submit_delay_ms:
      dist: "lognormal"
      mean: 700
      sigma: 0.55
      clamp_min: 200
      clamp_max: 8000

  slippage_model:
    enabled: true
    model: "amm_xyk"  # amm_xyk | constant_bps | hybrid
    constant_bps: 80
    impact_cap_bps: 200
    impact_formula: "size_over_liquidity"

  fill_model:
    enabled: true
    base_fill_rate: 0.80
    penalty_per_1000ms_latency: 0.03
    penalty_if_liquidity_below_min: 0.20
    penalty_if_spread_above_max: 0.20

backtest:
  enabled: true
  monte_carlo:
    enabled: true
    runs: 10000
    shuffle_trades: true
  metrics:
    track_by_mode: true
    track_by_dex: true
    track_by_wallet_source: true
  acceptance_targets:
    min_fill_rate: 0.70
    max_drawdown_pct: 25.0

monitoring:
  export:
    to_csv: true
    to_bigquery: false
  telegram_alerts:
    enabled: true
    alert_on_drawdown_pct_ge: 5.0
    alert_on_consecutive_losses_ge: 3
    alert_on_rpc_failover: true
  dashboard:
    enabled: true
    write_views:
      signals: true
      fills: true
      pnl: true
      latencies: true

# PR-M.2: Data-Track Orchestrator Configuration
data_track:
  ingest_lookback_days: 1
  profile_window_days: 30
  storage_path: "data/prod"
  staging_path: "data/staging"

# PR-F.3: Polymarket Regime Overlay Configuration
regime:
  polymarket:
    min_bullish_score: 0.1
    max_event_risk: 0.6
    fallback_to_risk_off: true

# PR-Q.1: Stats Feedback Loop - Auto-update configuration
auto_update:
  enabled: true
  min_days_required: 7
  ewma_alpha: 0.15
  bounds:
    mu_win: [0.01, 0.25]
    mu_loss: [0.005, 0.15]
  max_change_per_run: 0.20

# PR-Q.1: Payoff parameters (auto-tuned by stats feedback loop)
payoff_mu_win:
  U: 0.040
  S: 0.050
  M: 0.080
  L: 0.120

payoff_mu_loss:
  U: 0.020
  S: 0.030
  M: 0.040
  L: 0.060

# PR-PM.5: Risk Regime Integration Parameters
# Multiplier for risk_regime in edge correction formula
# Formula: edge_final = edge_raw * (1 + alpha * risk_regime)
regime:
  alpha: 0.20  # Range: [0.0, 0.5] - Higher values amplify regime impact

# PR-ML.4: Hazard Model Parameters
hazard_model:
  # Feature weights
  weight_liquidity_drop: 3.2
  weight_top_holder_sell: 2.8
  weight_mint_auth: 1.5
  weight_cluster_pressure: 2.1
  weight_pmkt_event: 1.0
  
  # Sigmoid transformation parameters
  sigmoid_k: 10.0
  sigmoid_x0: 0.5
  
  # Decision threshold for emergency exit
  hazard_threshold: 0.65
  
  # Calibration
  model_version: "hazard_v1"

# PR-RM.1: Polymarket-Aware Position Sizing Parameters
# Formula: position_pct_adjusted = base_position_pct * (1 + risk_beta * risk_regime)
position_sizing:
  base_position_pct: 0.02          # 2% base position size
  risk_beta: 0.5                   # Regime sensitivity (0.5 = ±25% at ±1.0 regime)
  max_position_pct_risk_on: 0.05   # Max 5% in risk-on regime
  min_position_pct_risk_off: 0.01  # Min 1% in risk-off regime
  max_trade_size_usd: 5000.0      # Absolute max trade size in USD
  min_trade_size_usd: 500.0       # Min trade size to execute
  max_kelly_fraction: 0.25        # Kelly fraction cap
  
  # Feature flags
  allow_risk_aware_sizing: true   # Enable adaptive position sizing
